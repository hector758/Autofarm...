--[[
Universal Noclip + Autofarm Marshmallow - OPTIMIZED + KEY SYSTEM
MortyHub - All in one
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local LP = Players.LocalPlayer

-- Key System Variables
local KEY_URL = "https://raw.githubusercontent.com/hector758/Test./refs/heads/main/Keysautofarm.json"
local keyData = {}
local keyVerified = false
local userID = tostring(LP.UserId)

-- Noclip State
local noclipEnabled = false
local originalCollisions = {}
local noclipConnection = nil
local flyMode = false
local movingUp = false
local movingDown = false
local bodyPos = nil
local heightIncrement = 0.5
local floatEnabled = false

-- Autofarm State
local farmEnabled = false
local step = 0
local timer = 0
local farmConnection = nil
local actionInProgress = false
local promptCache = {}
local lastCacheUpdate = 0
local bagCounts = {
    small = 0,
    medium = 0,
    large = 0
}
local lastBagCheck = 0

-- Performance optimization
local partCache = {}
local lastPartCacheUpdate = 0
local PART_CACHE_INTERVAL = 1
local NOCLIP_UPDATE_INTERVAL = 0.1
local MAX_DISTANCE = 40
local FLOOR_CHECK_DISTANCE = 8

-- ============================================
-- KEY SYSTEM FUNCTIONS
-- ============================================

local function loadKeyData()
    local success, result = pcall(function()
        local response = game:HttpGet(KEY_URL)
        local data = HttpService:JSONDecode(response)
        return data
    end)
    
    if success then
        keyData = result
        print("‚úÖ Key data loaded")
        return true
    else
        warn("‚ùå Failed to load key data: " .. tostring(result))
        return false
    end
end

local function verifyUserKey(inputKey)
    if keyData.users and keyData.users[userID] then
        local userData = keyData.users[userID]
        if userData.key == inputKey and userData.status == "active" then
            print("‚úÖ User verified: " .. (userData.username or userID))
            return true
        end
    end
    return false
end

-- ============================================
-- KEY SYSTEM GUI
-- ============================================

local function createKeyGUI()
    local keyGui = Instance.new("ScreenGui")
    keyGui.Name = "MortyHubKeySystem"
    keyGui.Parent = game:GetService("CoreGui")
    keyGui.ResetOnSpawn = false

    local keyFrame = Instance.new("Frame")
    keyFrame.Size = UDim2.new(0, 320, 0, 240)
    keyFrame.Position = UDim2.new(0.5, -160, 0.5, -120)
    keyFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    keyFrame.BorderSizePixel = 0
    keyFrame.Parent = keyGui

    local keyCorner = Instance.new("UICorner")
    keyCorner.CornerRadius = UDim.new(0, 12)
    keyCorner.Parent = keyFrame

    local keyTitle = Instance.new("TextLabel")
    keyTitle.Size = UDim2.new(1, 0, 0, 50)
    keyTitle.BackgroundTransparency = 1
    keyTitle.Text = "üîê MortyHub Key System"
    keyTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    keyTitle.TextSize = 20
    keyTitle.Font = Enum.Font.GothamBold
    keyTitle.Parent = keyFrame

    local userLabel = Instance.new("TextLabel")
    userLabel.Size = UDim2.new(1, -40, 0, 25)
    userLabel.Position = UDim2.new(0, 20, 0, 55)
    userLabel.BackgroundTransparency = 1
    userLabel.Text = "üë§ User ID: " .. userID
    userLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
    userLabel.TextSize = 12
    userLabel.Font = Enum.Font.Gotham
    userLabel.Parent = keyFrame

    local keyInput = Instance.new("TextBox")
    keyInput.Size = UDim2.new(1, -40, 0, 45)
    keyInput.Position = UDim2.new(0, 20, 0, 90)
    keyInput.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    keyInput.PlaceholderText = "Enter your key..."
    keyInput.PlaceholderColor3 = Color3.fromRGB(120, 120, 120)
    keyInput.Text = ""
    keyInput.TextColor3 = Color3.fromRGB(255, 255, 255)
    keyInput.TextSize = 14
    keyInput.Font = Enum.Font.Gotham
    keyInput.ClearTextOnFocus = false
    keyInput.Parent = keyFrame

    local keyInputCorner = Instance.new("UICorner")
    keyInputCorner.CornerRadius = UDim.new(0, 8)
    keyInputCorner.Parent = keyInput

    local verifyBtn = Instance.new("TextButton")
    verifyBtn.Size = UDim2.new(1, -40, 0, 45)
    verifyBtn.Position = UDim2.new(0, 20, 0, 145)
    verifyBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 50)
    verifyBtn.Text = "‚úì Verify Key"
    verifyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    verifyBtn.TextSize = 16
    verifyBtn.Font = Enum.Font.GothamBold
    verifyBtn.Parent = keyFrame

    local verifyBtnCorner = Instance.new("UICorner")
    verifyBtnCorner.CornerRadius = UDim.new(0, 8)
    verifyBtnCorner.Parent = verifyBtn

    local statusText = Instance.new("TextLabel")
    statusText.Size = UDim2.new(1, -40, 0, 35)
    statusText.Position = UDim2.new(0, 20, 0, 200)
    statusText.BackgroundTransparency = 1
    statusText.Text = "Loading..."
    statusText.TextColor3 = Color3.fromRGB(180, 180, 180)
    statusText.TextSize = 12
    statusText.Font = Enum.Font.Gotham
    statusText.Parent = keyFrame

    task.spawn(function()
        if loadKeyData() then
            statusText.Text = "‚úÖ Ready! Enter your key"
            statusText.TextColor3 = Color3.fromRGB(100, 255, 100)
        else
            statusText.Text = "‚ö†Ô∏è Connection error. Retry"
            statusText.TextColor3 = Color3.fromRGB(255, 100, 100)
        end
    end)

    verifyBtn.MouseButton1Click:Connect(function()
        local inputKey = keyInput.Text
        
        if inputKey == "" then
            statusText.Text = "‚ùå Please enter a key!"
            statusText.TextColor3 = Color3.fromRGB(255, 100, 100)
            return
        end

        statusText.Text = "Verifying..."
        statusText.TextColor3 = Color3.fromRGB(255, 255, 100)
        verifyBtn.Text = "‚è≥ Checking..."
        
        task.wait(0.8)
        
        if verifyUserKey(inputKey) then
            statusText.Text = "‚úÖ Access granted! Loading..."
            statusText.TextColor3 = Color3.fromRGB(100, 255, 100)
            verifyBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
            keyVerified = true
            
            task.wait(1)
            keyGui:Destroy()
            createMainGUI()
        else
            statusText.Text = "‚ùå Invalid key for this user!"
            statusText.TextColor3 = Color3.fromRGB(255, 100, 100)
            verifyBtn.Text = "‚úì Verify Key"
            verifyBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
            keyInput.Text = ""
            
            task.wait(1.5)
            verifyBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 50)
        end
    end)
end

-- ============================================
-- MAIN GUI
-- ============================================

function createMainGUI()
    local isMinimized = false
    
    local gui = Instance.new("ScreenGui")
    gui.Name = "MortyHubNoclip"
    gui.Parent = game:GetService("CoreGui")
    gui.ResetOnSpawn = false

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 220, 0, 260)
    frame.Position = UDim2.new(0.5, -110, 0.3, 0)
    frame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    frame.BorderSizePixel = 0
    frame.Active = true
    frame.Draggable = true
    frame.Parent = gui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = frame

    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 35)
    titleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    titleBar.BorderSizePixel = 0
    titleBar.Active = true
    titleBar.Parent = frame

    local titleBarCorner = Instance.new("UICorner")
    titleBarCorner.CornerRadius = UDim.new(0, 10)
    titleBarCorner.Parent = titleBar

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, -40, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "MortyHub"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextSize = 18
    title.Font = Enum.Font.GothamBold
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = titleBar

    local btnToggle = Instance.new("TextButton")
    btnToggle.Size = UDim2.new(0, 30, 0, 30)
    btnToggle.Position = UDim2.new(1, -35, 0, 2.5)
    btnToggle.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
    btnToggle.Text = "‚àí"
    btnToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
    btnToggle.TextSize = 20
    btnToggle.Font = Enum.Font.GothamBold
    btnToggle.Parent = titleBar

    local btnToggleCorner = Instance.new("UICorner")
    btnToggleCorner.CornerRadius = UDim.new(0, 6)
    btnToggleCorner.Parent = btnToggle

    local contentFrame = Instance.new("Frame")
    contentFrame.Size = UDim2.new(1, 0, 1, -35)
    contentFrame.Position = UDim2.new(0, 0, 0, 35)
    contentFrame.BackgroundTransparency = 1
    contentFrame.Parent = frame

    local btnNoclip = Instance.new("TextButton")
    btnNoclip.Size = UDim2.new(1, -20, 0, 40)
    btnNoclip.Position = UDim2.new(0, 10, 0, 10)
    btnNoclip.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
    btnNoclip.Text = "ENABLE NOCLIP"
    btnNoclip.TextColor3 = Color3.fromRGB(255, 255, 255)
    btnNoclip.TextSize = 14
    btnNoclip.Font = Enum.Font.GothamBold
    btnNoclip.Parent = contentFrame

    local btnNoclipCorner = Instance.new("UICorner")
    btnNoclipCorner.CornerRadius = UDim.new(0, 8)
    btnNoclipCorner.Parent = btnNoclip

    local btnFarm = Instance.new("TextButton")
    btnFarm.Size = UDim2.new(1, -20, 0, 40)
    btnFarm.Position = UDim2.new(0, 10, 0, 60)
    btnFarm.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
    btnFarm.Text = "START AUTOFARM"
    btnFarm.TextColor3 = Color3.fromRGB(255, 255, 255)
    btnFarm.TextSize = 14
    btnFarm.Font = Enum.Font.GothamBold
    btnFarm.Parent = contentFrame

    local btnFarmCorner = Instance.new("UICorner")
    btnFarmCorner.CornerRadius = UDim.new(0, 8)
    btnFarmCorner.Parent = btnFarm

    local btnUp = Instance.new("TextButton")
    btnUp.Size = UDim2.new(0, 40, 0, 30)
    btnUp.Position = UDim2.new(0, 10, 0, 110)
    btnUp.BackgroundColor3 = Color3.fromRGB(70, 130, 255)
    btnUp.Text = "‚ñ≤"
    btnUp.TextColor3 = Color3.fromRGB(255, 255, 255)
    btnUp.TextSize = 20
    btnUp.Font = Enum.Font.GothamBold
    btnUp.Active = false
    btnUp.Parent = contentFrame

    local btnUpCorner = Instance.new("UICorner")
    btnUpCorner.CornerRadius = UDim.new(0, 6)
    btnUpCorner.Parent = btnUp

    local btnDown = Instance.new("TextButton")
    btnDown.Size = UDim2.new(0, 40, 0, 30)
    btnDown.Position = UDim2.new(0, 60, 0, 110)
    btnDown.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
    btnDown.Text = "‚ñº"
    btnDown.TextColor3 = Color3.fromRGB(255, 255, 255)
    btnDown.TextSize = 20
    btnDown.Font = Enum.Font.GothamBold
    btnDown.Active = false
    btnDown.Parent = contentFrame

    local btnDownCorner = Instance.new("UICorner")
    btnDownCorner.CornerRadius = UDim.new(0, 6)
    btnDownCorner.Parent = btnDown

    local statusLabel = Instance.new("TextLabel")
    statusLabel.Size = UDim2.new(1, -110, 0, 30)
    statusLabel.Position = UDim2.new(0, 110, 0, 110)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = "E = Toggle\nQ = Fly"
    statusLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
    statusLabel.TextSize = 11
    statusLabel.Font = Enum.Font.Gotham
    statusLabel.TextYAlignment = Enum.TextYAlignment.Top
    statusLabel.Parent = contentFrame

    local bagCountLabel = Instance.new("TextLabel")
    bagCountLabel.Size = UDim2.new(1, -20, 0, 35)
    bagCountLabel.Position = UDim2.new(0, 10, 0, 145)
    bagCountLabel.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
    bagCountLabel.Text = "Marshmellow Bags: S:0 M:0 L:0"
    bagCountLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    bagCountLabel.TextSize = 11
    bagCountLabel.Font = Enum.Font.GothamBold
    bagCountLabel.Parent = contentFrame

    local bagCountCorner = Instance.new("UICorner")
    bagCountCorner.CornerRadius = UDim.new(0, 6)
    bagCountCorner.Parent = bagCountLabel

    local heightLabel = Instance.new("TextLabel")
    heightLabel.Size = UDim2.new(1, 0, 0, 20)
    heightLabel.Position = UDim2.new(0, 0, 1, -25)
    heightLabel.BackgroundTransparency = 1
    heightLabel.Text = "Height: 0"
    heightLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
    heightLabel.TextSize = 11
    heightLabel.Font = Enum.Font.Gotham
    heightLabel.Parent = contentFrame

    local farmStatusLabel = Instance.new("TextLabel")
    farmStatusLabel.Size = UDim2.new(1, 0, 0, 20)
    farmStatusLabel.Position = UDim2.new(0, 0, 1, -45)
    farmStatusLabel.BackgroundTransparency = 1
    farmStatusLabel.Text = "Farm: OFF"
    farmStatusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
    farmStatusLabel.TextSize = 11
    farmStatusLabel.Font = Enum.Font.Gotham
    farmStatusLabel.Parent = contentFrame

    -- ============================================
    -- MINIMIZE/MAXIMIZE FUNCTIONS
    -- ============================================

    local function toggleMinimize()
        isMinimized = not isMinimized
        
        if isMinimized then
            frame:TweenSize(
                UDim2.new(0, 220, 0, 35),
                Enum.EasingDirection.Out,
                Enum.EasingStyle.Quad,
                0.3,
                true
            )
            btnToggle.Text = "+"
            contentFrame.Visible = false
        else
            frame:TweenSize(
                UDim2.new(0, 220, 0, 260),
                Enum.EasingDirection.Out,
                Enum.EasingStyle.Quad,
                0.3,
                true
            )
            btnToggle.Text = "‚àí"
            contentFrame.Visible = true
        end
    end

    btnToggle.MouseButton1Click:Connect(toggleMinimize)

    btnToggle.MouseEnter:Connect(function()
        btnToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
    end)

    btnToggle.MouseLeave:Connect(function()
        btnToggle.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
    end)

    -- ============================================
    -- OPTIMIZED NOCLIP FUNCTIONS
    -- ============================================

    local function updatePartCache()
        local now = tick()
        if now - lastPartCacheUpdate < PART_CACHE_INTERVAL then return end
        
        partCache = {}
        local char = LP.Character
        if not char then return end
        
        for _, obj in ipairs(workspace:GetDescendants()) do
            if obj:IsA("BasePart") and obj.CanCollide and not obj:IsDescendantOf(char) then
                table.insert(partCache, obj)
            end
        end
        
        lastPartCacheUpdate = now
    end

    local function disableSmartCollisions()
        local char = LP.Character
        if not char then return end
        
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        
        local hrpPos = hrp.Position
        local hrpY = hrpPos.Y
        
        local processed = 0
        local maxPerFrame = 50
        
        for _, obj in ipairs(partCache) do
            if processed >= maxPerFrame then break end
            
            if obj and obj.Parent and obj.CanCollide then
                local objPos = obj.Position
                
                local dx = objPos.X - hrpPos.X
                local dz = objPos.Z - hrpPos.Z
                local distSq = dx * dx + dz * dz
                
                if distSq < MAX_DISTANCE * MAX_DISTANCE then
                    local heightDiff = objPos.Y - hrpY
                    
                    local isFloorBelow = heightDiff < 0 and 
                                         heightDiff > -6 and 
                                         distSq < FLOOR_CHECK_DISTANCE * FLOOR_CHECK_DISTANCE
                    
                    if not isFloorBelow or flyMode or floatEnabled then
                        if not originalCollisions[obj] then
                            originalCollisions[obj] = true
                        end
                        obj.CanCollide = false
                        processed = processed + 1
                    end
                end
            end
        end
    end

    local function restoreCollisions()
        local count = 0
        for obj, _ in pairs(originalCollisions) do
            if obj and obj.Parent then
                obj.CanCollide = true
                count = count + 1
                
                if count % 20 == 0 then
                    task.wait()
                end
            end
        end
        originalCollisions = {}
    end

    local function createBodyPosition()
        local char = LP.Character
        if not char then return end
        
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        
        if not bodyPos then
            bodyPos = Instance.new("BodyPosition")
            bodyPos.MaxForce = Vector3.new(0, math.huge, 0)
            bodyPos.D = 50
            bodyPos.P = 3000
            bodyPos.Position = hrp.Position
            bodyPos.Parent = hrp
            floatEnabled = true
        end
    end

    local function removeBodyPosition()
        if bodyPos then
            bodyPos:Destroy()
            bodyPos = nil
            floatEnabled = false
        end
    end

    -- ============================================
    -- AUTOFARM FUNCTIONS
    -- ============================================

    local function checkBagInventory()
        local now = tick()
        if now - lastBagCheck < 2 then return end
        lastBagCheck = now
        
        bagCounts = {
            small = 0,
            medium = 0,
            large = 0
        }
        
        task.spawn(function()
            local backpack = LP:FindFirstChild("Backpack")
            local char = LP.Character
            
            if backpack then
                for _, item in ipairs(backpack:GetChildren()) do
                    if item:IsA("Tool") then
                        local itemName = item.Name
                        if itemName == "Small Marshmellow Bag" then
                            bagCounts.small = bagCounts.small + 1
                        elseif itemName == "Medium Marshmellow Bag" then
                            bagCounts.medium = bagCounts.medium + 1
                        elseif itemName == "Large Marshmellow Bags" then
                            bagCounts.large = bagCounts.large + 1
                        end
                    end
                end
            end
            
            if char then
                for _, item in ipairs(char:GetChildren()) do
                    if item:IsA("Tool") then
                        local itemName = item.Name
                        if itemName == "Small Marshmellow Bag" then
                            bagCounts.small = bagCounts.small + 1
                        elseif itemName == "Medium Marshmellow Bag" then
                            bagCounts.medium = bagCounts.medium + 1
                        elseif itemName == "Large Marshmellow Bags" then
                            bagCounts.large = bagCounts.large + 1
                        end
                    end
                end
            end
            
            bagCountLabel.Text = string.format("Marshmellow Bags: S:%d M:%d L:%d", 
                bagCounts.small, 
                bagCounts.medium, 
                bagCounts.large
            )
            
            local totalBags = bagCounts.small + bagCounts.medium + bagCounts.large
            if totalBags == 0 then
                bagCountLabel.BackgroundColor3 = Color3.fromRGB(60, 35, 35)
            elseif totalBags < 5 then
                bagCountLabel.BackgroundColor3 = Color3.fromRGB(60, 50, 35)
            else
                bagCountLabel.BackgroundColor3 = Color3.fromRGB(35, 60, 35)
            end
        end)
    end

    local function updatePromptCache()
        promptCache = {}
        for _, obj in ipairs(workspace:GetDescendants()) do
            if obj:IsA("ProximityPrompt") then
                table.insert(promptCache, obj)
            end
        end
    end

    local function equipItem(name)
        task.spawn(function()
            local backpack = LP:FindFirstChild("Backpack")
            if backpack then
                local item = backpack:FindFirstChild(name)
                if item then
                    LP.Character.Humanoid:EquipTool(item)
                end
            end
        end)
    end

    local function interact()
        if actionInProgress then return end
        actionInProgress = true
        
        task.spawn(function()
            local char = LP.Character
            if not char then 
                actionInProgress = false
                return 
            end
            
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if not hrp then 
                actionInProgress = false
                return 
            end
            
            if tick() - lastCacheUpdate > 5 then
                updatePromptCache()
                lastCacheUpdate = tick()
            end
            
            local closest = nil
            local minDist = 20
            
            for _, prompt in ipairs(promptCache) do
                if prompt and prompt.Parent then
                    local parent = prompt.Parent
                    local pos
                    
                    if parent:IsA("BasePart") then
                        pos = parent.Position
                    elseif parent:IsA("Attachment") and parent.Parent:IsA("BasePart") then
                        pos = parent.Parent.Position
                    elseif parent:IsA("Model") then
                        local part = parent:FindFirstChildOfClass("BasePart")
                        if part then pos = part.Position end
                    end
                    
                    if pos then
                        local dist = (pos - hrp.Position).Magnitude
                        if dist < minDist then
                            minDist = dist
                            closest = prompt
                        end
                    end
                end
            end
            
            if closest then
                fireproximityprompt(closest)
            end
            
            local tool = char:FindFirstChildOfClass("Tool")
            if tool then
                tool:Activate()
            end
            
            actionInProgress = false
        end)
    end

    local function onFarmHeartbeat(deltaTime)
        if not farmEnabled then return end
        
        timer = timer + deltaTime
        checkBagInventory()
        
        if step == 1 then
            farmStatusLabel.Text = "Farm: Water (1/5)"
            if timer >= 1 and not actionInProgress then
                equipItem("Water")
                interact()
                step = 2
                timer = 0
            end
            
        elseif step == 2 then
            farmStatusLabel.Text = "Farm: Waiting... (2/5)"
            if timer >= 22 then
                equipItem("Sugar Block Bag")
                interact()
                step = 3
                timer = 0
            end
            
        elseif step == 3 then
            farmStatusLabel.Text = "Farm: Sugar (3/5)"
            if timer >= 2 then
                equipItem("Gelatin")
                interact()
                step = 4
                timer = 0
            end
            
        elseif step == 4 then
            farmStatusLabel.Text = "Farm: Gelatin (4/5)"
            if timer >= 47 then
                equipItem("Empty Bag")
                interact()
                step = 5
                timer = 0
            end
            
        elseif step == 5 then
            farmStatusLabel.Text = "Farm: Collecting (5/5)"
            if timer >= 3 then
                step = 1
                timer = 0
            end
        end
    end

    -- ============================================
    -- OPTIMIZED NOCLIP LOOP
    -- ============================================

    local lastUpdate = 0
    local heightUpdateCounter = 0

    local function noclipUpdateLoop()
        if not noclipEnabled then return end
        
        local now = tick()
        
        updatePartCache()
        
        if now - lastUpdate >= NOCLIP_UPDATE_INTERVAL then
            disableSmartCollisions()
            lastUpdate = now
        end
        
        if (movingUp or movingDown) and bodyPos then
            if movingUp then
                bodyPos.Position = bodyPos.Position + Vector3.new(0, heightIncrement, 0)
            elseif movingDown then
                bodyPos.Position = bodyPos.Position - Vector3.new(0, heightIncrement, 0)
            end
        end
        
        if flyMode then
            local char = LP.Character
            if char then
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if hrp then
                    hrp.AssemblyLinearVelocity = Vector3.new(
                        hrp.AssemblyLinearVelocity.X,
                        0,
                        hrp.AssemblyLinearVelocity.Z
                    )
                end
            end
        end
        
        heightUpdateCounter = heightUpdateCounter + 1
        if heightUpdateCounter >= 10 then
            local char = LP.Character
            if char then
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if hrp then
                    heightLabel.Text = "Height: " .. math.floor(hrp.Position.Y)
                end
            end
            heightUpdateCounter = 0
        end
    end

    -- ============================================
    -- BUTTON EVENTS
    -- ============================================

    btnNoclip.MouseButton1Click:Connect(function()
        noclipEnabled = not noclipEnabled
        
        if noclipEnabled then
            btnNoclip.Text = "DISABLE NOCLIP"
            btnNoclip.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
            
            print("Noclip Enabled")
            
            flyMode = false
            
            updatePartCache()
            disableSmartCollisions()
            
            if noclipConnection then
                noclipConnection:Disconnect()
            end
            noclipConnection = RunService.Heartbeat:Connect(noclipUpdateLoop)
            
        else
            btnNoclip.Text = "ENABLE NOCLIP"
            btnNoclip.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
            
            print("Noclip Disabled")
            
            flyMode = false
            movingUp = false
            movingDown = false
            removeBodyPosition()
            
            if noclipConnection then
                noclipConnection:Disconnect()
                noclipConnection = nil
            end
            
            task.spawn(restoreCollisions)
        end
    end)

    btnFarm.MouseButton1Click:Connect(function()
        farmEnabled = not farmEnabled
        
        if farmEnabled then
            btnFarm.Text = "STOP AUTOFARM"
            btnFarm.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
            step = 1
            timer = 0
            actionInProgress = false
            
            updatePromptCache()
            checkBagInventory()
            
            if farmConnection then
                farmConnection:Disconnect()
            end
            farmConnection = RunService.Heartbeat:Connect(onFarmHeartbeat)
            
            print("Autofarm Started")
        else
            btnFarm.Text = "START AUTOFARM"
            btnFarm.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
            farmStatusLabel.Text = "Farm: OFF"
            
            if farmConnection then
                farmConnection:Disconnect()
                farmConnection = nil
            end
            
            step = 0
            timer = 0
            actionInProgress = false
            
            print("Autofarm Stopped")
        end
    end)

    btnUp.MouseButton1Down:Connect(function()
        if not noclipEnabled then return end
        movingUp = true
        createBodyPosition()
        btnUp.BackgroundColor3 = Color3.fromRGB(100, 180, 255)
    end)

    btnUp.MouseButton1Up:Connect(function()
        movingUp = false
        btnUp.BackgroundColor3 = Color3.fromRGB(70, 130, 255)
    end)

    btnUp.MouseLeave:Connect(function()
        movingUp = false
        btnUp.BackgroundColor3 = Color3.fromRGB(70, 130, 255)
    end)

    btnDown.MouseButton1Down:Connect(function()
        if not noclipEnabled then return end
        movingDown = true
        createBodyPosition()
        btnDown.BackgroundColor3 = Color3.fromRGB(255, 130, 130)
    end)

    btnDown.MouseButton1Up:Connect(function()
        movingDown = false
        btnDown.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
    end)

    btnDown.MouseLeave:Connect(function()
        movingDown = false
        btnDown.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
    end)

    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.KeyCode == Enum.KeyCode.E then
            btnNoclip.MouseButton1Click:Fire()
            
        elseif input.KeyCode == Enum.KeyCode.Q and noclipEnabled then
            flyMode = not flyMode
            
            if flyMode then
                statusLabel.Text = "FLY MODE"
                statusLabel.TextColor3 = Color3.fromRGB(100, 255, 255)
                print("Fly Mode: ON")
                updatePartCache()
                disableSmartCollisions()
            else
                statusLabel.Text = "E = Toggle\nQ = Fly"
                statusLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
                print("Walk Mode: ON")
                removeBodyPosition()
                task.spawn(restoreCollisions)
                task.wait(0.2)
                updatePartCache()
                disableSmartCollisions()
            end
        end
    end)

    LP.CharacterAdded:Connect(function(char)
        if noclipEnabled or farmEnabled then
            noclipEnabled = false
            farmEnabled = false
            flyMode = false
            movingUp = false
            movingDown = false
            removeBodyPosition()
            
            if noclipConnection then
                noclipConnection:Disconnect()
                noclipConnection = nil
            end
            
            if farmConnection then
                farmConnection:Disconnect()
                farmConnection = nil
            end
            
            task.spawn(restoreCollisions)
            
            btnNoclip.Text = "ENABLE NOCLIP"
            btnNoclip.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
            
            btnFarm.Text = "START AUTOFARM"
            btnFarm.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
            farmStatusLabel.Text = "Farm: OFF"
            
            partCache = {}
            promptCache = {}
            bagCounts = {small = 0, medium = 0, large = 0}
            bagCountLabel.Text = "Marshmellow Bags: S:0 M:0 L:0"
            bagCountLabel.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
        end
    end)

    task.spawn(function()
        while task.wait(3) do
            if not isMinimized then
                checkBagInventory()
            end
        end
    end)

    print("‚úÖ MortyHub Main GUI Loaded")
    print("üéÆ E = Toggle Noclip | Q = Fly Mode")
    print("‚¨ÜÔ∏è‚¨áÔ∏è = Up/Down Buttons")
    print("üåæ Autofarm Available")
    print("üì¶ Bag Counter Active")
    print("‚ö° Performance Optimized")
end

-- ============================================
-- START KEY SYSTEM
-- ============================================

print("üîê MortyHub Loading...")
print("üë§ User ID: " .. userID)
createKeyGUI()